# B站直播弹幕排队管理系统

一个基于PyQt6的B站直播弹幕排队管理工具，支持弹幕监控、自动排队、插队管理和上车功能。

如需功能定制可以发送邮件联系！

mytianyi0712@outlook.com

## ✨ 主要功能

### 🎯 弹幕监控
- 实时监控B站直播间弹幕
- 支持登录和访客模式连接
- 自动重连机制
- 弹幕关键词自动识别
- 播报弹幕内容（支持自定义播报种类，以及播报内容）
> {message}：弹幕内容;
> {username}：用户名；
> {giftname}：礼物名字;
> {time}：舰长（包括提督、总督）的时长
> {guardname}：舰长类礼物的具体类型

### 📝 排队管理
- **排队功能**: 用户发送"排队"弹幕自动加入排队队列
- **插队功能**: 用户发送"插队"弹幕自动加入插队队列（需要足够次数）
- **上车功能**: 用户发送"上车"弹幕自动加入上车队列
- **手动管理**: 支持手动添加、完成、取消队列项目
- **重新排队**: 一键清空所有队列（排队、上车、插队）重新开始

### 🎲 随机选择
- 支持从排队队列中随机选择用户
- 动画效果展示选择过程
- 防重复中奖机制（最近10位中奖用户）

### 🛡️ 舰长礼物监控
- 自动检测舰长、提督、总督购买
- 根据等级自动分配排队次数
- 支持多月购买次数累计

### 📊 数据管理
- CSV格式名单管理
- 实时次数扣除和记录
- 状态自动保存和恢复
- 详细的操作日志

### ⚙️ 设置系统
- 可配置的日志级别（DEBUG/INFO/WARNING/ERROR/CRITICAL）
- 日志文件大小管理
- 独立窗口支持（可最小化到任务栏）
- 统一的日志格式化输出

### �️ 投票系统 (v1.9.0 新增)
- 支持任意标题与多选项创建投票
- 观众发送纯数字弹幕 (1/2/3...) 自动计票，每个用户 UID 仅计一次
- 支持可选“自动结束”倒计时（秒）
- 可保存当前配置为预设，下次直接载入
- 投票进行中可显示可拖动悬浮窗，实时展示票数与剩余时间
- 投票结束后可导出结果 JSON（包含完整统计与时间）
- 预设存储目录：`vote_presets/`，可手动备份迁移

## �🚀 快速开始

### 环境要求
- Python 3.8+
- Windows 10/11

### 安装依赖
```bash
pip install -r requirements.txt
```

### 配置设置
1. 复制配置文件模板：
   ```bash
   cp config.example.json config.json
   cp 名单.example.csv 名单.csv
   ```

2. 编辑 `config.json` 设置直播间ID和其他参数

3. 编辑 `名单.csv` 添加用户名单和次数

### 运行程序
```bash
python main.py
```

## ⚙️ 配置说明

### config.json
```json
{
  "danmaku": {
    "room_id": 13355,          # 直播间ID
    "auto_connect": false      # 是否自动连接
  },
  "queue": {
    "queue_cost": 1,           # 排队消耗次数
    "cutline_cost": 2,         # 插队消耗次数
    "name_list_file": "名单.csv"
  },
  "gift_monitor": {
    "guard_rewards": {
      "舰长": 10,              # 舰长奖励次数
      "提督": 20,              # 提督奖励次数
      "总督": 50               # 总督奖励次数
    }
  }
}
```

### 名单.csv格式
```csv
用户名1（100
用户名2(100
用户名3(15)
用户名4（120）
用户名5
```
分别对应解析为：100次，100次，15次，120次，1次

## 🎮 使用说明

### 基本操作
1. **启动程序**: 运行 `main.py`
2. **连接弹幕**: 输入房间号，点击"连接"
3. **打开排队窗口**: 点击"打开排队管理窗口"
4. **开始服务**: 分别点击"开始排队"、"开始插队"、"开始上车"

### 队列管理
- **排队队列**: 显示所有排队用户
- **插队队列**: 显示所有插队用户（消耗2次）
- **上车队列**: 显示所有上车用户
- **完成/取消**: 点击对应按钮完成或取消队列项目

### 随机选择
- 点击"随机"按钮开始动画选择
- 系统会避免最近10位中奖用户重复中奖

### 手动管理
- **手动添加**: 搜索并手动添加用户到指定队列
- **手动插队**: 直接插队到插队队列
- **名单编辑**: 实时编辑用户名单和次数

### 投票使用流程
1. 点击“🗳️ 开始投票”
2. 在弹出窗口中：
  - 可直接输入 标题 / 多个选项（一行一个）
  - 左侧（若存在）预设列表单击即可自动填充
  - 勾选“启用定时结束”可设置秒数
  - 勾选“保存为预设”以便下次复用
3. 观众发送纯数字“1”“2”……即可投票（每 UID 仅首次有效）
4. 可随时隐藏/显示悬浮窗
5. 点击“✅ 结束投票”后：结果弹窗显示，并自动关闭悬浮窗
6. 结束后若需再次查看结果，使用“� 查看投票结果”按钮

注意：
- 仅处理完全是数字的弹幕，且在有效选项范围内
- 相同 UID 只记录第一次有效投票
- 结束后才能导出结果；新的投票会重置上次数据

## �🔧 打包部署

使用提供的打包脚本构建exe程序：

```bash
python build_exe.py
```

打包完成后，程序位于 `dist/子轩专属排队工具/` 目录中。

## 📝 开发说明

### 核心架构
- **GUI层**: PyQt6界面
- **业务层**: 队列管理逻辑
- **数据层**: CSV文件存储
- **API层**: bilibili-api集成

### 主要类说明
- `QueueManager`: 队列管理核心类
- `DanmakuMonitorThread`: 弹幕监控线程
- `SimpleQueueManagerWindow`: 排队管理窗口
- `BilibiliDanmakuMonitor`: 主窗口

## 🐛 常见问题

### 连接问题
- 检查网络连接
- 确认直播间ID正确
- 尝试重新连接

### 弹幕识别问题
- 检查关键词设置
- 确认服务已开启
- 查看日志输出

### 数据丢失
- 程序会自动保存状态
- 检查CSV文件权限
- 查看备份文件

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📞 联系方式

如有问题，请通过GitHub Issues联系。

或者通过邮箱联系：mytianyi0712@outlook.com

## 📋 更新日志

### v1.9.0 (2025-09-25)
**新增：**
- 投票系统：开始 / 结束 / 预设 / 半透明悬浮窗 / 结果查看
- 预设列表直接整合到“创建投票”对话框
- 数字弹幕一票制 & 可选自动倒计时结束

**改进：**
- 投票结束后自动关闭悬浮窗，可用“📊 查看投票结果”再次查看
- 悬浮窗视觉升级：大字体、自适应字号、颜色分层

**结构：**
- 新增 `vote/` 模块：`vote_models.py`、`vote_manager.py`、`vote_overlay.py`

---

### v1.9 (2025-10-8)
- 移除扶贫用工具。
- 添加tts播报功能，现阶段支持使用：edge-tts，KokoroTTS，pyttsx3。
- 添加加载界面，优化使用体验。

### v1.8 (2025-8-12)
**修复：**
- 修复部分情况下插队功能的完成和取消按钮不能正常工作的问题
- 修复日志记录系统存在的严重重复问题
- 修复主窗口标题显示异常问题

**修改：**
- UI界面优化调整
- 窗口逻辑改进：排队窗口从子窗口变为独立窗口，支持正确最小化到任务栏
- 重新排队按钮现在会同时重置插队队列
- 将扶贫排队工具合并到主项目中
- 程序2版本改为单人抽奖模式

**新增：**
- 设置功能：支持日志级别和日志文件大小配置
- 统一的日志格式化系统
- 独立窗口管理系统

### v1.7.1 (2025-8-7)
**修复：**
- 修复主窗口标题显示为"<property object at 0x...>"的问题

### v1.7 (2025-7-21)
**变更：**
- 随机数算法升级，提升随机性
- UI界面调整
- 开始使用Git和GitHub进行版本管理

**新增：**
- 已中奖队列机制（长度10的先进先出队列）
- 自动检测插队功能
- 版本管理模块

---

> **注意**: 本工具仅供学习和合法使用，请遵守相关平台的服务条款。
