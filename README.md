# B站直播弹幕排队管理系统

一个基于PyQt6的B站直播弹幕排队管理工具，支持弹幕监控、自动排队、插队管理和上车功能。

## ✨ 主要功能

### 🎯 弹幕监控
- 实时监控B站直播间弹幕
- 支持登录和访客模式连接
- 自动重连机制
- 弹幕关键词自动识别

### 📝 排队管理
- **排队功能**: 用户发送"排队"弹幕自动加入排队队列
- **插队功能**: 用户发送"插队"弹幕自动加入插队队列（需要足够次数）
- **上车功能**: 用户发送"上车"弹幕自动加入上车队列
- **手动管理**: 支持手动添加、完成、取消队列项目

### 🎲 随机选择
- 支持从排队队列中随机选择用户
- 动画效果展示选择过程
- 防重复中奖机制（最近10位中奖用户）

### 🛡️ 舰长礼物监控
- 自动检测舰长、提督、总督购买
- 根据等级自动分配排队次数
- 支持多月购买次数累计

### 📊 数据管理
- CSV格式名单管理
- 实时次数扣除和记录
- 状态自动保存和恢复
- 详细的操作日志

## 🚀 快速开始

### 环境要求
- Python 3.8+
- Windows 10/11

### 安装依赖
```bash
pip install -r requirements.txt
```

### 配置设置
1. 复制配置文件模板：
   ```bash
   cp config.example.json config.json
   cp 名单.example.csv 名单.csv
   ```

2. 编辑 `config.json` 设置直播间ID和其他参数

3. 编辑 `名单.csv` 添加用户名单和次数

### 运行程序
```bash
python main.py
```

## 📁 项目结构

```
├── main.py                 # 程序入口
├── gui/                    # GUI界面模块
│   ├── main_window.py     # 主窗口
│   ├── queue_window_simple.py  # 排队管理窗口
│   ├── login_dialog.py    # 登录对话框
│   └── ...
├── bilibili/              # B站API相关
│   ├── danmaku.py        # 弹幕监控
│   └── login.py          # 登录管理
├── queue_manager/         # 排队管理核心
│   └── manager.py        # 队列管理器
├── models/               # 数据模型
├── utils/                # 工具函数
├── config/               # 配置管理
└── resource/             # 资源文件
    └── icon/            # 程序图标
```

## ⚙️ 配置说明

### config.json
```json
{
  "danmaku": {
    "room_id": 13355,          # 直播间ID
    "auto_connect": false      # 是否自动连接
  },
  "queue": {
    "queue_cost": 1,           # 排队消耗次数
    "cutline_cost": 2,         # 插队消耗次数
    "name_list_file": "名单.csv"
  },
  "gift_monitor": {
    "guard_rewards": {
      "舰长": 10,              # 舰长奖励次数
      "提督": 20,              # 提督奖励次数
      "总督": 50               # 总督奖励次数
    }
  }
}
```

### 名单.csv格式
```csv
用户名1（100
用户名2(100
用户名3(15)
用户名4（120）
用户名5
```
分别对应解析为：100次，100次，15次，120次，1次

## 🎮 使用说明

### 基本操作
1. **启动程序**: 运行 `main.py`
2. **连接弹幕**: 输入房间号，点击"连接"
3. **打开排队窗口**: 点击"打开排队管理窗口"
4. **开始服务**: 分别点击"开始排队"、"开始插队"、"开始上车"

### 队列管理
- **排队队列**: 显示所有排队用户
- **插队队列**: 显示所有插队用户（消耗2次）
- **上车队列**: 显示所有上车用户
- **完成/取消**: 点击对应按钮完成或取消队列项目

### 随机选择
- 点击"随机"按钮开始动画选择
- 系统会避免最近10位中奖用户重复中奖

### 手动管理
- **手动添加**: 搜索并手动添加用户到指定队列
- **手动插队**: 直接插队到插队队列
- **名单编辑**: 实时编辑用户名单和次数

## 🔧 打包部署

使用提供的打包脚本构建exe程序：

```bash
python build_exe.py
```

打包完成后，程序位于 `dist/子轩专属排队工具/` 目录中。

## 📝 开发说明

### 核心架构
- **GUI层**: PyQt6界面
- **业务层**: 队列管理逻辑
- **数据层**: CSV文件存储
- **API层**: bilibili-api集成

### 主要类说明
- `QueueManager`: 队列管理核心类
- `DanmakuMonitorThread`: 弹幕监控线程
- `SimpleQueueManagerWindow`: 排队管理窗口
- `BilibiliDanmakuMonitor`: 主窗口

## 🐛 常见问题

### 连接问题
- 检查网络连接
- 确认直播间ID正确
- 尝试重新连接

### 弹幕识别问题
- 检查关键词设置
- 确认服务已开启
- 查看日志输出

### 数据丢失
- 程序会自动保存状态
- 检查CSV文件权限
- 查看备份文件

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📞 联系方式

如有问题，请通过GitHub Issues联系。

---

> **注意**: 本工具仅供学习和合法使用，请遵守相关平台的服务条款。
